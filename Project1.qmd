---
title: "Project1"
format: pdf
editor: visual
---

##Data Processing Step 1: Select columns

```{r}
library(dplyr)
library(tidyr)

first_data <- read.csv('EDU01a.csv')

selected_columns <- first_data |> 
  select(area_name = Area_name, STCOU, ends_with("D"))

head(selected_columns, n = 5)
```

##Data Processing Step 2: Covert data into long format

```{r}

pivoted_data <- selected_columns |>
  pivot_longer(cols=3:12,names_to="Enrollment", values_to ="Enrollment_Value") |>
  select(-STCOU)

head(pivoted_data, n = 5)
```

##Data Processing Step 3: Separate Enrollment Variable

```{r}

long_updated <- pivoted_data |>
   mutate(Survey = substr(Enrollment, 1,7), Year = as.numeric(substr(Enrollment, 8,9))) |>
  mutate(Year=ifelse(Year>80, 1900+Year,2000+Year)) |>
  select(area_name, Survey, Year, Enrollment_Value)

head(long_updated, n = 5)
```

##Data Processing Step 4: Create two new data sets: country_tibble and state_tibble

```{r}
county_tibble <- long_updated|>
  filter(grepl(",",area_name)) |> 
  mutate(county=grep(pattern =", \\w\\w", area_name))

class(county_tibble) <- c("county", class(county_tibble))
  
head(county_tibble, n = 10)

state_tibble <- long_updated|>
  filter(!grepl(",",area_name)) 

class(state_tibble) <- c("state", class(state_tibble))
  
head(state_tibble, n = 10)
```

##Data Processing Step 5: Create new variable that describes which state one of these country measurements correspondents to

```{r}
county_tibble <-county_tibble |>
  mutate(state = substr(area_name, nchar(area_name)-2, nchar(area_name)))
```

##Data Processing Step 6: For non-county level tibble, create a variable called division

```{r}
state_tibble <- state_tibble |>
  mutate(division = case_when(
    area_name %in% c("CONNECTICUT","MAINE","MASSACHUSETTS","NEW HAMPSHIRE","RHODE ISLAND","VERMONT") ~ "New England",
    area_name %in% c("NEW JERSEY","NEW YORK","PENNSYLVANIA") ~ "Mid-Atlantic",
    area_name %in% c("ILLINOIS","INDIANA","MICHIGAN","OHIO","WISCONSIN") ~ "East North Central",
    area_name %in% c("IOWA","KANSAS","MINNESOTA","MISSOURI","NEBRASKA","NORTH DAKOTA","SOUTH DAKOTA") ~ "West North Central",
    area_name %in% c("DELAWARE","DISTRICT OF COLUMBIA","FLORIDA","GEORGIA","MARYLAND","NORTH CAROLINA","SOUTH CAROLINA","VIRGINIA","WEST VIRGINIA") ~ "South Atlantic",
    area_name %in% c("ALABAMA","KENTUCKY","MISSISSIPPI","TENNESSEE") ~ "East South Central",
    area_name %in% c("ARKANSAS","LOUISIANA","OKLAHOMA","TEXAS") ~ "West South Central",
    area_name %in% c("ARIZONA","COLORADO","IDAHO","MONTANA","NEVADA","NEW MEXICO","UTAH","WYOMING") ~ "Mountain",
    area_name %in% c("ALASKA","CALIFORNIA","HAWAII","OREGON","WASHINGTON") ~ "Pacific",
    TRUE ~ "ERROR"
    )
  )
```

##Data Processing Function Writing

```{r}
# Function for reading in code
read_csv_code <- function(filename,column_name){
  library(dplyr)
  library(tidyr)
  first_data <- read.csv(filename)
  return(first_data)
}

# Function for steps 1 and 2  
function_for_steps_1_2 <- function(first_data, column_name){
  selected_columns <- first_data |> 
    select(area_name = Area_name, STCOU, ends_with("D"))
  pivoted_data <- selected_columns |>
    pivot_longer(cols=3:12,names_to=column_name, values_to ="Enrollment_Value") |>
    select(-STCOU)
  print(pivoted_data)
  return(pivoted_data)
}

# Function taking in the output from step 2 and executing step 3
function_for_step_3 <- function(pivoted_data,column_name){
  long_updated <- pivoted_data |>
    mutate(Survey = substr(pivoted_data[[column_name]], 1,7), Year = as.numeric(substr(pivoted_data[[column_name]], 8,9))) |>
    mutate(Year=ifelse(Year>80, 1900+Year,2000+Year)) |>
    select(area_name, Survey, Year, Enrollment_Value)
  return(long_updated)
}

# Function for step 4
function_for_step_4 <- function(long_updated){
  county_tibble <- long_updated|>
    filter(grepl(",",area_name)) |> 
    mutate(county=grep(pattern =", \\w\\w", area_name))
  class(county_tibble) <- c("county", class(county_tibble))
  state_tibble <- long_updated|>
    filter(!grepl(",",area_name)) 
  class(state_tibble) <- c("state", class(state_tibble))
  return(county_tibble, state_tibble)
}

# Function for step 5
function_for_step_5 <- function(county_tibble){
  county_tibble <-county_tibble |>
  mutate(state = substr(area_name, nchar(area_name)-2, nchar(area_name)))
  return(county_tibble)
}

# Function for step 6
function_for_step_6 <- function(state_tibble){
  state_tibble <- state_tibble |>
  mutate(division = case_when(
    area_name %in% c("CONNECTICUT","MAINE","MASSACHUSETTS","NEW HAMPSHIRE","RHODE ISLAND","VERMONT") ~ "New England",
    area_name %in% c("NEW JERSEY","NEW YORK","PENNSYLVANIA") ~ "Mid-Atlantic",
    area_name %in% c("ILLINOIS","INDIANA","MICHIGAN","OHIO","WISCONSIN") ~ "East North Central",
    area_name %in% c("IOWA","KANSAS","MINNESOTA","MISSOURI","NEBRASKA","NORTH DAKOTA","SOUTH DAKOTA") ~ "West North Central",
    area_name %in% c("DELAWARE","DISTRICT OF COLUMBIA","FLORIDA","GEORGIA","MARYLAND","NORTH CAROLINA","SOUTH CAROLINA","VIRGINIA","WEST VIRGINIA") ~ "South Atlantic",
    area_name %in% c("ALABAMA","KENTUCKY","MISSISSIPPI","TENNESSEE") ~ "East South Central",
    area_name %in% c("ARKANSAS","LOUISIANA","OKLAHOMA","TEXAS") ~ "West South Central",
    area_name %in% c("ARIZONA","COLORADO","IDAHO","MONTANA","NEVADA","NEW MEXICO","UTAH","WYOMING") ~ "Mountain",
    area_name %in% c("ALASKA","CALIFORNIA","HAWAII","OREGON","WASHINGTON") ~ "Pacific",
    TRUE ~ "ERROR"
    )
  )
  return(state_tibble)
}

# Function for steps 4, 5, 6
function_for_steps_4_5_6 <- function(long_updated){
  county_tibble <- long_updated|>
    filter(grepl(",",area_name)) |> 
    mutate(county=grep(pattern =", \\w\\w", area_name))
  class(county_tibble) <- c("county", class(county_tibble))
  state_tibble <- long_updated|>
    filter(!grepl(",",area_name)) 
  class(state_tibble) <- c("state", class(state_tibble))
  results5 <- function_for_step_5(county_tibble)
  results6 <- function_for_step_6(state_tibble)
  return(list=c(county_data =results5, state_data =results6))
}
  

# Wrapper function
processing_wrapper <- function(url,column_name){
  result <- read_csv_code(url) |>
    (\(data)function_for_steps_1_2(data,column_name))() |>
    (\(data)function_for_step_3(data,column_name))() |>
    function_for_steps_4_5_6()
  
  return(result)
}

results1 <- processing_wrapper("https://www4.stat.ncsu.edu/~online/datasets/EDU01b.csv",'Enrollment')
results2 <- processing_wrapper("https://www4.stat.ncsu.edu/~online/datasets/EDU01a.csv",'Enrollment')


CombiningFunction <- function(data1,data2){
  county_data <- bind_rows(data1[1:6],data2[1:6])
  noncounty_data <- bind_rows(data1[7:11],data2[7:11])
   combined <- list(county_data=tibble(county_data),
                    noncounty_data=tibble(noncounty_data))
return(combined)
 }


Data_Combined<-CombiningFunction(results1,results2)
class(Data_Combined)
class(Data_Combined$county_data)

```

##Writing a generic function of summarizing Step 1: Test out function

```{r}
#Plot function for state data
library(ggplot2)
plot.state <- function(df,var_name="state_data.Enrollment_Value"){
   plot_data <- df|> group_by(state_data.division, state_data.Year)|>
    summarize(y_axis=mean(get(var_name))) |>
    filter(state_data.division != 'ERROR') 
   
   print(plot_data)
  ggplot(data=plot_data, aes(x=state_data.Year,y= y_axis,color=state_data.division)) + geom_line() +
    labs(y="Average Enrollment", x="Year", color="Division")
}

plot.state(Data_Combined[[2]],)

```

##Writing a generic function of summarizing Step 1: Create function for the class county

```{r}
#Plot function for county data
plot.county <- function(df,var_name="county_data.Enrollment_Value", state = ' AL',group='TOP',
                        n=5){
   plot_data <- df |> filter(county_data.state== state) |>
   group_by(county_data.area_name)|>
     summarize(y_axis=mean(get(var_name))) 
   
   print(plot_data)
   if(group=='TOP'){
     plot_data2 <- plot_data |>
       arrange(desc(y_axis)) |>
       slice_head(n= n) 
   } else {
     plot_data2 <- plot_data |> 
       arrange(y_axis)|>
       slice_head(n= n) 
   }

   plot_data2$county_data.area_name <-factor(plot_data2$county_data.area_name, 
                                             levels= plot_data2$county_data.area_name)
     
   print(plot_data2)
   ggplot(data=plot_data2, aes(x=county_data.area_name,y= y_axis, group =1)) + geom_line() +geom_point() + labs(y="Average Enrollment", x="County Name") +scale_y_continuous(limits=c(10000,150000),breaks = seq(10000,120000,10000))
}

plot.county(Data_Combined[[1]])
plot.county(Data_Combined[[1]],state = ' AZ')
plot.county(Data_Combined[[1]],state = ' PA')

```


##Putting it Together 
```{r}

#Orginal two URlS

results1 <- processing_wrapper("https://www4.stat.ncsu.edu/~online/datasets/EDU01b.csv",'Enrollment')
results2 <- processing_wrapper("https://www4.stat.ncsu.edu/~online/datasets/EDU01a.csv",'Enrollment')
Data_Combined<-CombiningFunction(results1,results2)
plot.state(Data_Combined[[2]],)
plot.county(Data_Combined[[1]],state = ' NC',group = 'TOP', n=20)
plot.county(Data_Combined[[1]],state = ' SC',group = 'BOTTOM', n=7)
plot.county(Data_Combined[[1]])
plot.county(Data_Combined[[1]],state = ' PA',group = 'TOP', n=8)
#Additional four URLs


```

